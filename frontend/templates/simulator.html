<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Store Simulator - RetailMind</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <style>
        .simulator-type-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .sim-type-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .sim-type-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .sim-type-card.active {
            border-color: #3498db;
            background: #f0f7fb;
        }

        .sim-input-panel {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            max-width: 600px;
            margin: 0 auto;
        }

        .result-dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .result-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            animation: fadeIn 0.5s ease-out;
        }

        .result-value {
            font-size: 2rem;
            font-weight: bold;
            margin: 10px 0;
        }

        .hidden {
            display: none;
        }
    </style>
</head>

<body>
    <div class="container">
        <header class="header">
            <h1>üß™ Store-Level Simulator</h1>
            <p class="subtitle">Simulate strategic changes across your entire inventory</p>
        </header>

        <nav class="breadcrumb">
            <a href="/">Home</a> > <a href="/dashboard">Dashboard</a> > Store Simulator
        </nav>

        <main class="main-content">
            <div class="simulator-type-cards">
                <div class="sim-type-card active" onclick="selectGlobalSim('price')">
                    <h3>üí∞ Global Price Change</h3>
                    <p>Adjust all prices by a percentage to test elasticity.</p>
                </div>
                <div class="sim-type-card" onclick="selectGlobalSim('promo')">
                    <h3>üè∑Ô∏è Store-wide Sale</h3>
                    <p>Run a promotion across all products.</p>
                </div>
                <div class="sim-type-card" onclick="selectGlobalSim('marketing')">
                    <h3>üì£ Marketing Campaign</h3>
                    <p>Simulate ad spend impact on store traffic.</p>
                </div>
            </div>

            <!-- Global Price Panel -->
            <div id="panel-price" class="sim-input-panel">
                <h3>Global Price Adjustment</h3>
                <p>Simulate raising or lowering prices for products.</p>

                <div class="sim-group" style="margin-top:20px;">
                    <label>Target Segment</label>
                    <select id="price-segment" class="sim-select">
                        <option value="all">All Products</option>
                        <option value="high_risk">High Risk Only</option>
                        <option value="opportunity">Opportunities Only</option>
                    </select>

                    <label style="margin-top:15px">Price Change Percentage % (+/-)</label>
                    <div class="input-row">
                        <input type="number" id="global-price-pct" value="5" step="1">
                        <button onclick="runGlobalSimulation('price_change')" class="btn-sim">Simulate Impact</button>
                    </div>
                    <small>Example: Enter 5 to increase prices by 5%. Enter -10 to decrease by 10%.</small>
                </div>
            </div>

            <!-- Global Promo Panel -->
            <div id="panel-promo" class="sim-input-panel hidden">
                <h3>Store-wide Promotion</h3>
                <p>Simulate a sale event.</p>

                <div class="sim-group" style="margin-top:20px;">
                    <label>Target Segment</label>
                    <select id="promo-segment" class="sim-select">
                        <option value="all">All Products</option>
                        <option value="high_risk">High Risk Only (Clearance)</option>
                        <option value="opportunity">Opportunities Only</option>
                    </select>

                    <label style="margin-top:15px">Discount Percentage %</label>
                    <input type="number" id="global-discount-pct" value="15" step="1"
                        style="width:100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 4px;">

                    <label>Duration (Days)</label>
                    <div class="input-row">
                        <input type="number" id="global-duration" value="3" step="1">
                        <button onclick="runGlobalSimulation('promotion')" class="btn-sim">Simulate Event</button>
                    </div>
                </div>
            </div>

            <!-- Marketing Panel -->
            <div id="panel-marketing" class="sim-input-panel hidden">
                <h3>Marketing Campaign ROI</h3>
                <p>Simulate investing in traffic growth.</p>

                <div class="sim-group" style="margin-top:20px;">
                    <label>Total Ad Spend ($)</label>
                    <input type="number" id="market-spend" value="1000" step="100"
                        style="width:100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 4px;">

                    <label>Expected Traffic Lift %</label>
                    <div class="input-row">
                        <input type="number" id="market-lift" value="20" step="5">
                        <button onclick="runGlobalSimulation('marketing')" class="btn-sim">Simulate Campaign</button>
                    </div>
                </div>
            </div>

            <!-- Results Data -->
            <div id="global-results" class="hidden">
                <h2 style="margin-top: 40px; text-align: center;">Predicted Impact</h2>

                <div class="result-dashboard">
                    <div class="result-card">
                        <h4>Total Revenue Change</h4>
                        <p id="res-rev-val" class="result-value">$0</p>
                        <p id="res-rev-pct" style="font-weight:bold;">0%</p>
                    </div>

                    <div class="result-card">
                        <h4>Demand Change</h4>
                        <p id="res-demand-pct" class="result-value">0%</p>
                        <p>in total units sold</p>
                    </div>

                    <div class="result-card">
                        <h4>Products Impacted</h4>
                        <p id="res-count" class="result-value">0</p>
                        <p>products analyzed</p>
                    </div>
                </div>

                <div style="text-align: center; margin-top: 30px;">
                    <p id="res-action" style="font-size: 1.2rem; font-weight: bold; color: #555;"></p>
                </div>
            </div>

        </main>

        <footer class="footer">
            <nav class="nav">
                <a href="/">Home</a>
                <a href="/dashboard">Dashboard</a>
                <a href="/insights">Insights</a>
                <a href="/simulator" style="font-weight:bold;">Simulator</a>
                <a href="/about">About</a>
            </nav>
        </footer>
    </div>

    <script src="/static/js/app.js"></script>
    <script>
        function selectGlobalSim(type) {
            // Update Cards
            document.querySelectorAll('.sim-type-card').forEach(c => c.classList.remove('active'));
            // Use event target safely or find by type
            const card = Array.from(document.querySelectorAll('.sim-type-card')).find(c => c.innerHTML.includes(type === 'promo' ? 'Sale' : (type === 'marketing' ? 'Marketing' : 'Price')));
            if (card) card.classList.add('active');

            // Toggle Panels
            ['price', 'promo', 'marketing'].forEach(p => document.getElementById(`panel-${p}`).classList.add('hidden'));
            document.getElementById(`panel-${type}`).classList.remove('hidden');

            // Hide results
            document.getElementById('global-results').classList.add('hidden');
        }

        async function runGlobalSimulation(scenario) {
            let params = {};
            if (scenario === 'price_change') {
                params = {
                    pct_change: document.getElementById('global-price-pct').value,
                    segment: document.getElementById('price-segment').value
                };
            } else if (scenario === 'promotion') {
                params = {
                    discount_pct: document.getElementById('global-discount-pct').value,
                    duration_days: document.getElementById('global-duration').value,
                    segment: document.getElementById('promo-segment').value
                };
            } else if (scenario === 'marketing') {
                params = {
                    ad_spend: document.getElementById('market-spend').value,
                    lift_pct: document.getElementById('market-lift').value,
                    segment: 'all'
                };
            }

            // Loading UI
            const btns = document.querySelectorAll('.btn-sim');
            btns.forEach(b => {
                b.setAttribute('data-original', b.textContent); // Store original text
                b.textContent = 'Simulating...';
                b.disabled = true;
            });

            try {
                const query = new URLSearchParams(params).toString();
                const res = await fetch(`/api/v1/simulator/all?scenario=${scenario}&${query}`);
                const data = await res.json();

                // Render Results
                document.getElementById('global-results').classList.remove('hidden');

                let revChange = data.summary.total_revenue_change;
                let revPct = data.summary.revenue_change_pct;
                let demandPct = data.summary.demand_change_pct;

                // Special handling for marketing net profit
                if (scenario === 'marketing') {
                    // Show Net Profit instead of just Gross Revenue?
                    // Let's force the label to say "Net Profit Impact"
                    // Actually, let's just stick to Revenue for consistency but mention Profit in text
                    revChange = data.summary.net_profit_impact; // We calculated this in backend
                    document.querySelector('#res-rev-val').previousElementSibling.textContent = "Net Profit Impact";
                } else {
                    document.querySelector('#res-rev-val').previousElementSibling.textContent = "Total Revenue Change";
                }

                const revValElem = document.getElementById('res-rev-val');
                revValElem.textContent = (revChange > 0 ? '+' : '') + '$' + Math.abs(revChange).toLocaleString();
                revValElem.style.color = revChange >= 0 ? '#27ae60' : '#e74c3c';

                const revPctElem = document.getElementById('res-rev-pct');
                revPctElem.textContent = (revPct > 0 ? '+' : '') + revPct + '%';
                revPctElem.style.color = revPct >= 0 ? '#27ae60' : '#e74c3c';

                document.getElementById('res-demand-pct').textContent = (demandPct > 0 ? '+' : '') + demandPct + '%';
                document.getElementById('res-count').textContent = data.products_impacted;

                const action = document.getElementById('res-action');
                if (data.summary.action === 'POSITIVE') {
                    action.textContent = "‚úÖ Recommendation: This strategy is projected to be PROFITABLE.";
                    action.style.color = "#27ae60";
                } else {
                    action.textContent = "‚ö†Ô∏è Warning: This strategy may reduce profitability.";
                    action.style.color = "#e74c3c";
                }


            } catch (e) {
                console.error(e);
                alert("Simulation failed");
            } finally {
                btns.forEach(b => {
                    b.textContent = b.getAttribute('data-original') || 'Simulate';
                    b.disabled = false;
                });
            }
        }
    </script>
</body>

</html>